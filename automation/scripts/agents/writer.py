"""
ì‘ì„± ì—ì´ì „íŠ¸
ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì¢… ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.
ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¥¼ ì¤€ìˆ˜í•˜ì—¬ ê³ í’ˆì§ˆì˜ ê¸€ì„ ìƒì„±í•œë‹¤.
"""

import io
import os
import re
import sys
from pathlib import Path
from typing import Dict
from google import genai

# Windows ì½˜ì†”ì—ì„œ í•œê¸€ ì¶œë ¥ì´ ê¹¨ì§€ëŠ” ë¬¸ì œ ì™„í™” (UTF-8 ê°•ì œ)
if sys.platform.startswith("win"):
    try:
        if hasattr(sys.stdout, "reconfigure"):
            sys.stdout.reconfigure(encoding="utf-8")
        else:
            sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding="utf-8")
        if hasattr(sys.stderr, "reconfigure"):
            sys.stderr.reconfigure(encoding="utf-8")
        else:
            sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding="utf-8")
    except Exception:
        pass


class WriterAgent:
    """ì‘ì„± ì—ì´ì „íŠ¸ - ìµœì¢… ê¸€ ì‘ì„±"""
    
    def __init__(self, api_key: str):
        self.client = genai.Client(api_key=api_key)
        # ëª¨ë¸ì€ í™˜ê²½/ê¶Œí•œì— ë”°ë¼ ê°€ìš©ì„±ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í´ë°± ì²´ì¸ì„ ë‘”ë‹¤.
        # - ì¼ë¶€ í™˜ê²½ì—ì„œëŠ” íŠ¹ì • ëª¨ë¸ì´ 404/NOT_FOUNDë¡œ ì‹¤íŒ¨í•  ìˆ˜ ìˆë‹¤.
        # - ì´ ê²½ìš° ë‹¤ìŒ í›„ë³´ë¡œ ìë™ í´ë°±í•œë‹¤.
        self.model_candidates = [
            os.getenv("GEMINI_WRITER_MODEL"),
            "models/gemini-2.5-flash",
            "models/gemini-2.0-flash-exp",
            "models/gemini-2.0-flash",
            "models/gemini-flash-latest",
        ]
        self.model_candidates = [m for m in self.model_candidates if m]
        self.model = self.model_candidates[0]
    
    def _is_korean_output(self, text: str) -> bool:
        """
        ëª¨ë¸ ì¶œë ¥ì´ í•œêµ­ì–´ ë³¸ë¬¸ìœ¼ë¡œì„œ ìµœì†Œ í’ˆì§ˆì„ ë§Œì¡±í•˜ëŠ”ì§€ ì ê²€í•œë‹¤.
        
        ê²€ì¦ í•­ëª©:
        1. ê¸°ë³¸ í•œê¸€ ë¹„ìœ¨ ê²€ì‚¬ (150ì ì´ìƒ, 20% ì´ìƒ)
        2. ì¢…ê²°ì–´ë¯¸ ê²€ì‚¬ (ë¬¸ì¥ì˜ 50% ì´ìƒì´ '~ë‹¤.'ë¡œ ëë‚˜ì•¼ í•¨)
        3. ì•/ë’¤ ë¶„í•  ê²€ì‚¬ (Language Switching ë°©ì§€)
        """
        if not text:
            return False
        
        # 1. ì½”ë“œ ë¸”ë¡ ì œê±° (í•œê¸€ ë¹„ìœ¨ ì™œê³¡ ë°©ì§€)
        text_wo_code = re.sub(r"```[\s\S]*?```", "", text)

        # 2. ê¸°ë³¸ í•œê¸€ ë¹„ìœ¨ ê²€ì‚¬ (ê¸°ì¤€ ìƒí–¥: 150ì, 20%)
        hangul_count = len(re.findall(r"[ê°€-í£]", text_wo_code))
        non_ws = len(re.sub(r"\s+", "", text_wo_code))
        
        if non_ws == 0:
            return False
        
        if hangul_count < 150:
            print(f"  [WARN] í•œê¸€ ìˆ˜ ë¶€ì¡±: {hangul_count}ì (ìµœì†Œ 150ì í•„ìš”)")
            return False
        
        hangul_ratio = hangul_count / non_ws
        if hangul_ratio < 0.2:
            print(f"  [WARN] í•œê¸€ ë¹„ìœ¨ ë¶€ì¡±: {hangul_ratio*100:.1f}% (ìµœì†Œ 20% í•„ìš”)")
            return False

        # 3. ì¢…ê²°ì–´ë¯¸ ê²€ì‚¬ (ë¬¸ì²´ í†µì¼ì„± ë³´ì¥)
        lines = text_wo_code.split('\n')
        valid_sentences = 0
        total_sentences = 0
        
        for line in lines:
            line = line.strip()
            # ì§§ì€ ì œëª©ì´ë‚˜ ë¹ˆ ì¤„, íŠ¹ìˆ˜ë¬¸ìëŠ” ê±´ë„ˆëœ€
            if len(line) < 10 or line.startswith('#') or line.startswith('-') or line.startswith('*'):
                continue
            
            total_sentences += 1
            # ë¬¸ì¥ ëì´ 'ë‹¤.'ë¡œ ëë‚˜ëŠ”ì§€ ì •ê·œì‹ ì²´í¬ ('ë‹¤.' ë’¤ì— ê°ì£¼[1] ë“±ì´ ì˜¬ ìˆ˜ë„ ìˆìŒ ê³ ë ¤)
            if re.search(r'ë‹¤\s*(\[.*?\])?\.$', line) or line.endswith('ë‹¤.'):
                valid_sentences += 1
        
        # ë³¸ë¬¸ ë¬¸ì¥ ì¤‘ 50% ì´ìƒì´ '~ë‹¤.'ë¡œ ëë‚˜ì•¼ í•©ê²©
        if total_sentences > 0:
            sentence_ratio = valid_sentences / total_sentences
            if sentence_ratio < 0.5:
                print(f"  [WARN] ë¬¸ì²´ ê²€ì¦ ì‹¤íŒ¨: '~ë‹¤.'ë¡œ ëë‚˜ëŠ” ë¬¸ì¥ ë¹„ìœ¨ì´ ë‚®ìŒ ({valid_sentences}/{total_sentences}, {sentence_ratio*100:.1f}%)")
                return False

        # 4. ì•/ë’¤ ë¶„í•  ê²€ì‚¬ (Language Switching ë°©ì§€)
        length = len(text_wo_code)
        if length > 0:
            quarter = max(length // 4, 100)  # ìµœì†Œ 100ì ë‹¨ìœ„
            
            first_part = text_wo_code[:quarter]
            last_part = text_wo_code[-quarter:]
            
            # ëë¶€ë¶„ì—ë„ í•œê¸€ì´ ì¶©ë¶„íˆ ìˆëŠ”ì§€ í™•ì¸
            last_hangul_count = len(re.findall(r"[ê°€-í£]", last_part))
            if last_hangul_count < 20:
                print(f"  [WARN] í›„ë°˜ë¶€ í•œê¸€ ë¶€ì¡± (ì–¸ì–´ ì „í™˜ ì˜ì‹¬): {last_hangul_count}ì")
                return False

        return True

    def write(self, topic: Dict, research_data: Dict, analysis_data: Dict) -> str:
        """
        ì¡°ì‚¬ ë° ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.
        
        Args:
            topic: ì£¼ì œ ì •ë³´
            research_data: ì¡°ì‚¬ ë°ì´í„°
            analysis_data: ë¶„ì„ ë°ì´í„°
            
        Returns:
            str: ì‘ì„±ëœ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ë³¸ë¬¸
        """
        category = topic.get('category', 'document')
        system_prompt = self._get_system_prompt(category)
        
        # ì¡°ì‚¬ ë° ë¶„ì„ ë°ì´í„° ì •ë¦¬
        research_text = research_data.get('raw_research', '')[:2000] if research_data.get('raw_research') else ''
        analysis_text = analysis_data.get('insights', '')[:1500] if analysis_data.get('insights') else ''
        
        # Bloomberg ë‹¤ì´ì œìŠ¤íŠ¸ëŠ” ë³„ë„ í”„ë¡¬í”„íŠ¸ ì‚¬ìš© (ì¹´í…Œê³ ë¦¬ë³´ë‹¤ ìš°ì„ )
        if (topic.get("source") == "bloomberg_rss") or (topic.get("type") == "bloomberg_digest"):
            base_prompt = self._get_bloomberg_digest_prompt(topic, research_text, analysis_text, system_prompt)
        # Daily ì¹´í…Œê³ ë¦¬ëŠ” ë³„ë„ì˜ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
        elif category == 'daily':
            base_prompt = self._get_daily_prompt(topic, research_text, analysis_text, system_prompt)
        else:
            # í”„ë¡¬í”„íŠ¸ë¥¼ ë” ê°„ë‹¨í•˜ê³  ëª…í™•í•˜ê²Œ êµ¬ì„±
            # âš ï¸ ë§¤ìš° ì¤‘ìš”: í”„ë¡¬í”„íŠ¸ ë§¨ ì•ì— í•œêµ­ì–´ ì‘ì„± ì§€ì‹œë¥¼ ëª…í™•íˆ ë°°ì¹˜
            # ì¡°ì‚¬/ë¶„ì„ ê²°ê³¼ê°€ ì˜ì–´ì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í•œêµ­ì–´ë¡œ ë²ˆì—­ ìš”ì²­ì„ ëª…ì‹œ
            base_prompt = f"""ë‹¹ì‹ ì€ í•œêµ­ì–´ë¡œë§Œ ê¸€ì„ ì“°ëŠ” ê¸°ìˆ  ë¸”ë¡œê·¸ ì‘ê°€ì…ë‹ˆë‹¤.

**âš ï¸ ë§¤ìš° ì¤‘ìš”: ì´ ìš”ì²­ì— ëŒ€í•œ ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.**

**âš ï¸ í•„ìˆ˜ ê·œì¹™ (ì ˆëŒ€ ìœ„ë°˜ ê¸ˆì§€):**
1. ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. ì˜ì–´ ë¬¸ì¥ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
2. ì˜ì–´ ë‹¨ì–´ëŠ” ê³ ìœ ëª…ì‚¬ë‚˜ ê¸°ìˆ  ìš©ì–´(ì˜ˆ: "CSV", "API", "Chaos Communication Congress")ë§Œ ìµœì†Œí•œìœ¼ë¡œ í—ˆìš©í•©ë‹ˆë‹¤.
3. ì¡°ì‚¬ ê²°ê³¼ë‚˜ ë¶„ì„ ì¸ì‚¬ì´íŠ¸ê°€ ì˜ì–´ë¡œ ë˜ì–´ ìˆì–´ë„, ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì—¬ ì„¤ëª…í•˜ì„¸ìš”.
4. ì˜ì–´ ì œëª©ì´ë‚˜ ì˜ì–´ ì„¤ëª…ì´ ìˆì–´ë„, ë³¸ë¬¸ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
5. ì˜ˆì‹œ:
   - âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: "Chaos Communication CongressëŠ” í•´ì»¤ ì»¨í¼ëŸ°ìŠ¤ë‹¤."
   - âŒ ì˜ëª»ëœ ì˜ˆ: "Chaos Communication Congress is a hacker conference."

**ì£¼ì œ:**
ì œëª©: {topic.get('title', '')}
ì„¤ëª…: {topic.get('description', '')}
ì¹´í…Œê³ ë¦¬: {topic.get('category', 'document')}

**ì¡°ì‚¬ ê²°ê³¼ (ì•„ë˜ ì˜ì–´ ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì—¬ ì„¤ëª…):**
{research_text[:1500]}

**ë¶„ì„ ì¸ì‚¬ì´íŠ¸ (ì•„ë˜ ì˜ì–´ ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì—¬ ì„¤ëª…):**
{analysis_text[:1000]}

**ì¤‘ìš”:** ìœ„ ì¡°ì‚¬ ê²°ê³¼ì™€ ë¶„ì„ ì¸ì‚¬ì´íŠ¸ê°€ ì˜ì–´ë¡œ ë˜ì–´ ìˆì–´ë„, ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì—¬ ì„¤ëª…í•˜ì„¸ìš”.

**ì‘ì„± ìš”êµ¬ì‚¬í•­:**
1. ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. ì˜ì–´ ë¬¸ì¥ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
2. ëª¨ë“  ë¬¸ì¥ì€ "~ë‹¤."ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.
3. ìµœì†Œ 1500ì ì´ìƒ ì‘ì„±í•˜ì„¸ìš”.
4. ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
5. ì „ë¬¸ê°€ ì˜ê²¬ì€ blockquote í˜•ì‹ìœ¼ë¡œ ì¸ìš©í•˜ì„¸ìš”.
6. ì™¸ë¶€ ìë£ŒëŠ” [^n] í˜•ì‹ìœ¼ë¡œ ì°¸ì¡°í•˜ê³ , ë§ˆì§€ë§‰ì— ## References ì„¹ì…˜ì„ ì¶”ê°€í•˜ì„¸ìš”.

**[ë²ˆì—­ ì „ëµ]**: ì¡°ì‚¬ ìë£Œê°€ ì˜ì–´ì¼ ê²½ìš°, ë‚´ìš©ì„ ì™„ì „íˆ ì´í•´í•œ í›„ **ë‹¹ì‹ ì˜ ì–¸ì–´(í•œêµ­ì–´)ë¡œ ë‹¤ì‹œ ì„œìˆ **í•˜ì‹­ì‹œì˜¤. ì˜ì–´ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê±°ë‚˜ ë²ˆì—­íˆ¬ë¡œ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤. ì˜ì–´ ì›ë¬¸ì„ í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì¬êµ¬ì„±í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”.

**[ì‹¤íŒ¨ ì¡°ê±´]**: ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ìê¸° ì˜ì–´ê°€ ë“±ì¥í•˜ê±°ë‚˜, ì½”ë“œ ì„¤ëª…ì´ ì˜ì–´ë¡œ ë˜ì–´ ìˆìœ¼ë©´ ì‘ì„±ì´ ì‹¤íŒ¨í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤. ì„œë¡ ì€ í•œê¸€ë¡œ ì˜ ì“°ë‹¤ê°€ ë³¸ë¡ ë¶€í„° ì˜ì–´ë¡œ ë°”ë€ŒëŠ” ê²½ìš°ë„ ì‹¤íŒ¨ì…ë‹ˆë‹¤.

{system_prompt}
"""
        
        try:
            content = ""
            last_error: str | None = None

            # ëª¨ë¸ì´ ë¹„ì •ìƒ ì¶œë ¥(ì˜ë¬¸/ê³µë°± ìœ„ì£¼)í•˜ëŠ” ì¼€ì´ìŠ¤ê°€ ìˆì–´, ìµœëŒ€ 3íšŒê¹Œì§€ ì¬ì‹œë„í•œë‹¤.
            for attempt in range(1, 4):
                print(f"  [ì‘ì„±] ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì‘ì„± ì¤‘... (ì‹œë„ {attempt}/3, ëª¨ë¸: {self.model})")

                writing_prompt = base_prompt
                if attempt >= 2:
                    # í•œê¸€ ëˆ„ë½/ê³µë°± ì¹˜í™˜ ë°©ì–´ë¥¼ ìœ„í•´ ìš”êµ¬ì‚¬í•­ì„ ë” ê°•í•˜ê²Œ ê³ ì •í•œë‹¤.
                    writing_prompt += """

**âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ì¶”ê°€ ì œì•½:**
- ì¶œë ¥ì€ **ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ** ì‘ì„±í•˜ì„¸ìš”. ì˜ì–´ë¡œ ì‘ì„±í•˜ë©´ ì¦‰ì‹œ ì‹¤íŒ¨ì…ë‹ˆë‹¤.
- ëª¨ë“  ë¬¸ì¥ì€ í•œê¸€ë¡œ ì‘ì„±í•˜ì„¸ìš”. ì˜ì–´ ë¬¸ì¥ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
- ê³ ìœ ëª…ì‚¬ë‚˜ ê¸°ìˆ  ìš©ì–´(ì˜ˆ: "CSV", "API", "JSON")ë§Œ ìµœì†Œí•œìœ¼ë¡œ ì˜ì–´ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤.
- ë³¸ë¬¸ì—ì„œ í•œêµ­ì–´ê°€ ê³µë°±ìœ¼ë¡œ ëŒ€ì²´ë˜ê±°ë‚˜, ì˜ë¬¸/ê¸°í˜¸/ê³µë°± ìœ„ì£¼ë¡œ ì¶œë ¥ë˜ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
- ì˜ˆì‹œ: "CSV íŒŒì¼ì„ ì‚¬ìš©í•œë‹¤" (O), "Use CSV file" (X)
"""

                # API í˜¸ì¶œ (ëª¨ë¸ì´ ì—†ìœ¼ë©´ í›„ë³´ ëª¨ë¸ë¡œ í´ë°±)
                try:
                    response = self.client.models.generate_content(
                        model=self.model,
                        contents=writing_prompt
                    )
                    content = (response.text or "").strip()
                    
                    # ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìœ¼ë©´ ì—ëŸ¬ ì¶œë ¥
                    if not content:
                        print(f"  [ERROR] API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
                        continue
                    if len(content) < 100:
                        print(f"  [ERROR] API ì‘ë‹µì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤: {len(content)}ì")
                        print(f"  [DEBUG] ì‘ë‹µ ë‚´ìš©: {content}")
                        continue
                    
                    # ë””ë²„ê¹…: ìƒì„±ëœ ë‚´ìš©ì˜ ì¼ë¶€ì™€ í•œê¸€ í†µê³„ ì¶œë ¥
                    preview = content[:300] if len(content) > 300 else content
                    hangul_count = len(re.findall(r'[ê°€-í£]', content))
                    text_wo_code = re.sub(r'```[\s\S]*?```', '', content)
                    hangul_count_wo_code = len(re.findall(r'[ê°€-í£]', text_wo_code))
                    non_ws = len(re.sub(r'\s+', '', text_wo_code))
                    hangul_ratio = (hangul_count_wo_code / non_ws * 100) if non_ws > 0 else 0
                    
                    print(f"  [DEBUG] ìƒì„±ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {preview}...")
                    print(f"  [DEBUG] ì „ì²´ ê¸¸ì´: {len(content)}ì")
                    print(f"  [DEBUG] í•œê¸€ ìˆ˜ (ì „ì²´): {hangul_count}ì")
                    print(f"  [DEBUG] í•œê¸€ ìˆ˜ (ì½”ë“œ ì œì™¸): {hangul_count_wo_code}ì")
                    print(f"  [DEBUG] í•œê¸€ ë¹„ìœ¨ (ì½”ë“œ ì œì™¸): {hangul_ratio:.1f}%")
                except Exception as e:
                    last_error = str(e)
                    # ëª¨ë¸ ë¯¸ì¡´ì¬/ê¶Œí•œ ë¬¸ì œ(404/NOT_FOUND)ë©´ ë‹¤ìŒ í›„ë³´ë¡œ í´ë°±í•œë‹¤.
                    err_upper = last_error.upper()
                    if ("404" in err_upper) or ("NOT_FOUND" in err_upper):
                        next_model = None
                        for m in self.model_candidates:
                            if m == self.model:
                                continue
                            next_model = m
                            break
                        if next_model:
                            print(f"  [WARN] ëª¨ë¸ í˜¸ì¶œ ì‹¤íŒ¨(ëª¨ë¸ ë¯¸ì¡´ì¬/ê¶Œí•œ ê°€ëŠ¥): {self.model} -> {next_model}")
                            self.model = next_model
                            continue
                    print(f"  [ERROR] API í˜¸ì¶œ ì‹¤íŒ¨: {last_error}")
                    continue

                # í›„ì²˜ë¦¬: ì´ëª¨ì§€ ì œê±° ë° ë¬¸ì²´ ê°œì„ 
                content = self._post_process(content)

                # ë””ë²„ê¹…: ìƒì„±ëœ ë‚´ìš© ì¼ë¶€ ì¶œë ¥
                if attempt == 1:
                    preview = content[:200] if len(content) > 200 else content
                    print(f"  [DEBUG] ìƒì„±ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {preview}...")
                    text_wo_code = re.sub(r"```[\s\S]*?```", "", content)
                    hangul_count = len(re.findall(r"[ê°€-í£]", text_wo_code))
                    non_ws = len(re.sub(r"\s+", "", text_wo_code))
                    hangul_ratio = (hangul_count / non_ws * 100) if non_ws > 0 else 0
                    print(f"  [DEBUG] í•œê¸€ ìˆ˜(ì½”ë“œ ì œì™¸): {hangul_count}, í•œê¸€ ë¹„ìœ¨(ì½”ë“œ ì œì™¸): {hangul_ratio:.1f}%")

                if len(content.strip()) < 800:
                    print(f"  [WARN] ê¸¸ì´ ë¶€ì¡±: {len(content.strip())}ì")
                    continue
                # ê²€ì¦ ì „ ìƒì„¸ í†µê³„ ì¶œë ¥
                text_wo_code = re.sub(r"```[\s\S]*?```", "", content)
                hangul_count = len(re.findall(r"[ê°€-í£]", text_wo_code))
                non_ws = len(re.sub(r"\s+", "", text_wo_code))
                hangul_ratio = (hangul_count / non_ws * 100) if non_ws > 0 else 0
                
                # ì¢…ê²°ì–´ë¯¸ í†µê³„
                lines = text_wo_code.split('\n')
                valid_sentences = 0
                total_sentences = 0
                for line in lines:
                    line = line.strip()
                    if len(line) < 10 or line.startswith('#') or line.startswith('-') or line.startswith('*'):
                        continue
                    total_sentences += 1
                    if re.search(r'ë‹¤\s*(\[.*?\])?\.$', line) or line.endswith('ë‹¤.'):
                        valid_sentences += 1
                sentence_ratio = (valid_sentences / total_sentences * 100) if total_sentences > 0 else 0
                
                print(f"  [DEBUG] ê²€ì¦ ì „ í†µê³„:")
                print(f"    - ì „ì²´ ê¸¸ì´: {len(content)}ì")
                print(f"    - í•œê¸€ ìˆ˜ (ì½”ë“œ ì œì™¸): {hangul_count}ì")
                print(f"    - í•œê¸€ ë¹„ìœ¨ (ì½”ë“œ ì œì™¸): {hangul_ratio:.1f}%")
                print(f"    - '~ë‹¤.'ë¡œ ëë‚˜ëŠ” ë¬¸ì¥: {valid_sentences}/{total_sentences} ({sentence_ratio:.1f}%)")
                
                if not self._is_korean_output(content):
                    print(f"  [ERROR] í•œêµ­ì–´ ê²€ì¦ ì‹¤íŒ¨!")
                    print(f"  [DEBUG] ê²€ì¦ ì‹¤íŒ¨ ë‚´ìš© ìƒ˜í”Œ (ì²˜ìŒ 800ì):")
                    print(f"    {content[:800]}")
                    if len(content) > 1000:
                        print(f"  [DEBUG] ê²€ì¦ ì‹¤íŒ¨ ë‚´ìš© ìƒ˜í”Œ (ì¤‘ê°„ 800ì):")
                        print(f"    {content[len(content)//2:len(content)//2+800]}")
                    print(f"  [DEBUG] ê²€ì¦ ì‹¤íŒ¨ ë‚´ìš© ìƒ˜í”Œ (ë 800ì):")
                    print(f"    {content[-800:] if len(content) > 800 else content}")
                    
                    # GitHub Actionsì—ì„œ ë””ë²„ê¹…ì„ ìœ„í•´ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
                    try:
                        import tempfile
                        temp_dir = Path(tempfile.gettempdir())
                        debug_file = temp_dir / f"failed_content_attempt_{attempt}.txt"
                        debug_file.write_text(content, encoding="utf-8")
                        print(f"  [DEBUG] ê²€ì¦ ì‹¤íŒ¨ ë‚´ìš©ì´ ì„ì‹œ íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {debug_file}")
                    except Exception as e:
                        print(f"  [WARN] ì„ì‹œ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: {e}")
                    
                    continue

                break

            # 1ì°¨ ì‹œë„ ì‹¤íŒ¨ ì‹œ ë ˆê±°ì‹œ fallback(ê°„ë‹¨ í”„ë¡¬í”„íŠ¸)ë„ ìˆ˜í–‰í•œë‹¤.
            if not content or len(content.strip()) < 800 or not self._is_korean_output(content):
                if last_error:
                    print(f"  [WARN] 1ì°¨ ì‘ì„± ì‹¤íŒ¨. ë§ˆì§€ë§‰ ì˜¤ë¥˜: {last_error}")
                print("  [WARN] 1ì°¨ ì‘ì„± ì‹¤íŒ¨. ê°„ë‹¨ í”„ë¡¬í”„íŠ¸ë¡œ ì¬ì‹œë„í•œë‹¤.")
                content = ""

            # ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìœ¼ë©´ ì¬ì‹œë„(ë ˆê±°ì‹œ fallback)
            if not content or len(content) < 500:
                print(f"  [WARN] ì‘ë‹µì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤ ({len(content)}ì). ì¬ì‹œë„...")
                simple_prompt = f"""ë‹¤ìŒ ì£¼ì œì— ëŒ€í•´ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

**ì œëª©:** {topic.get('title', '')}
**ì„¤ëª…:** {topic.get('description', '')}

ì¡°ì‚¬ ê²°ê³¼:
{research_data.get('raw_research', '')[:1000]}

ë¶„ì„ ì¸ì‚¬ì´íŠ¸:
{analysis_data.get('insights', '')[:500]}

"~ë‹¤."ë¡œ ëë‚˜ëŠ” ê±´ì¡°í•œ ë¬¸ì²´ë¡œ, ìµœì†Œ 1200ì ì´ìƒ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ì´ëª¨ì§€ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”."""
                
                response = self.client.models.generate_content(
                    model=self.model,
                    contents=simple_prompt
                )
                content = response.text
            
            # ì‘ë‹µ ê²€ì¦
            if not content or len(content.strip()) < 500:
                print(f"  [WARN] ì‘ë‹µì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤ ({len(content)}ì). ì¬ì‹œë„...")
                # ë” ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸ë¡œ ì¬ì‹œë„
                simple_prompt = f"""ë‹¤ìŒ ì£¼ì œì— ëŒ€í•´ ì™„ì „í•œ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

ì œëª©: {topic.get('title', '')}
ì„¤ëª…: {topic.get('description', '')}

ì¡°ì‚¬ ê²°ê³¼ ìš”ì•½:
{research_text[:800]}

ë¶„ì„ ìš”ì•½:
{analysis_text[:500]}

**ì¤‘ìš”:**
- ëª¨ë“  ë¬¸ì¥ì„ ì™„ì „í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”
- "~ë‹¤."ë¡œ ëë‚˜ëŠ” ë¬¸ì²´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
- ì´ëª¨ì§€ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- ìµœì†Œ 1500ì ì´ìƒ ì‘ì„±í•˜ì„¸ìš”
- í•œê¸€ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•˜ì„¸ìš”"""
                
                response = self.client.models.generate_content(
                    model=self.model,
                    contents=simple_prompt
                )
                content = response.text
            
            # í›„ì²˜ë¦¬: ì´ëª¨ì§€ ì œê±° ë° ë¬¸ì²´ ê°œì„ 
            content = self._post_process(content)
            
            # ë‚´ìš© ê²€ì¦
            if len(content.strip()) < 500:
                print(f"  [ERROR] ìµœì¢… ì½˜í…ì¸ ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤ ({len(content)}ì)")
                return ""

            if not self._is_korean_output(content):
                print("  [ERROR] ìµœì¢… ì½˜í…ì¸ ì˜ í•œêµ­ì–´ í’ˆì§ˆ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                return ""
            
            print(f"  [OK] ì‘ì„± ì™„ë£Œ ({len(content)}ì)")
            
            return content
            
        except Exception as e:
            print(f"  [ERROR] ì‘ì„± ì˜¤ë¥˜: {str(e)}")
            return ""
    
    def _post_process(self, content: str) -> str:
        """ìƒì„±ëœ ì½˜í…ì¸  í›„ì²˜ë¦¬"""
        # ì´ëª¨ì§€ ì œê±°
        emoji_pattern = re.compile(r"[\U00010000-\U0010ffff]", flags=re.UNICODE)
        content = emoji_pattern.sub("", content)
        
        # ë¬¸ì¥ ëì„ "~ë‹¤."ë¡œ í†µì¼ (ì œëª©/í—¤ë”/ë¦¬ìŠ¤íŠ¸ëŠ” ì œì™¸)
        lines = content.split('\n')
        processed_lines = []
        for line in lines:
            original_line = line
            line = line.strip()
            if not line:
                processed_lines.append('')
                continue
            
            # ì œëª©/í—¤ë”ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ (#ìœ¼ë¡œ ì‹œì‘)
            if line.startswith('#'):
                processed_lines.append(original_line)
                continue
            
            # ë¦¬ìŠ¤íŠ¸ í•­ëª©ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (-, *, ìˆ«ìë¡œ ì‹œì‘)
            if re.match(r'^[-*â€¢]\s+', line) or re.match(r'^\d+[.)]\s+', line):
                processed_lines.append(original_line)
                continue
            
            # "ë¬´ì—‡ì´ ìƒˆë¡œì› ë‚˜", "1ì°¨ ì˜í–¥ ê²½ë¡œ", "ë¦¬ìŠ¤í¬" ê°™ì€ ê°€ì´ë“œ ë¬¸êµ¬ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
            if re.search(r'(ë¬´ì—‡ì´ ìƒˆë¡œì› ë‚˜|ì˜í–¥ ê²½ë¡œ|ë¦¬ìŠ¤í¬.*ê´€ì°° í¬ì¸íŠ¸)', line):
                processed_lines.append(original_line)
                continue
            
            # ì¸ìš©ë¬¸(blockquote)ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
            if line.startswith('>'):
                processed_lines.append(original_line)
                continue
            
            # ì½”ë“œ ë¸”ë¡ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
            if line.startswith('```'):
                processed_lines.append(original_line)
                continue
            
            # ì´ë¯¸ "~ë‹¤."ë¡œ ëë‚˜ë©´ ê·¸ëŒ€ë¡œ
            if line.endswith('ë‹¤.'):
                processed_lines.append(original_line)
            # ë‹¤ë¥¸ ì¢…ê²°ì–´ë¯¸ê°€ ìˆìœ¼ë©´ "~ë‹¤."ë¡œ ë³€ê²½ (ê°„ë‹¨í•œ ê²½ìš°ë§Œ)
            elif line.endswith("ìš”."):
                processed_lines.append(original_line[:-2] + "ë‹¤.")
            elif line.endswith("ì–´ìš”."):
                processed_lines.append(original_line[:-3] + "ë‹¤.")
            elif line.endswith('ìŠµë‹ˆë‹¤.'):
                processed_lines.append(original_line[:-4] + "ë‹¤.")
            else:
                # ì´ë¯¸ ì ì ˆí•œ ì¢…ê²°ì–´ë¯¸ê°€ ìˆê±°ë‚˜, ë¬¸ì¥ì´ ì•„ë‹Œ ê²½ìš° ê·¸ëŒ€ë¡œ ìœ ì§€
                # (ì˜ˆ: "~ì´ë‹¤.", "~í–ˆë‹¤.", "~ì˜€ë‹¤." ë“±ì€ ì´ë¯¸ ì ì ˆí•¨)
                if re.search(r'[ë‹¤í–ˆì˜€ì„ìŒ]$', line) or line.endswith('.') or line.endswith('!'):
                    processed_lines.append(original_line)
                else:
                    # ì¢…ê²°ì–´ë¯¸ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ "ë‹¤." ì¶”ê°€ (í•˜ì§€ë§Œ ë„ˆë¬´ ì§§ì€ ì¤„ì€ ì œì™¸)
                    if len(line) > 10:
                        processed_lines.append(original_line + "ë‹¤.")
                    else:
                        processed_lines.append(original_line)
        
        return '\n'.join(processed_lines)

    def _get_bloomberg_digest_prompt(self, topic: Dict, research_text: str, analysis_text: str, system_prompt: str) -> str:
        """Bloomberg ì „ì¼ ë‰´ìŠ¤ ë‹¤ì´ì œìŠ¤íŠ¸ ì „ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        title = topic.get("title", "")
        desc = topic.get("description", "")
        
        # í”„ë¡¬í”„íŠ¸ íŒŒì¼ ì½ê¸°
        prompt_file = Path(__file__).parent.parent / "prompts" / "bloomberg_daily_digest.md"
        base_prompt = ""
        if prompt_file.exists():
            base_prompt = prompt_file.read_text(encoding="utf-8")
        else:
            # í´ë°±: ê¸°ë³¸ í”„ë¡¬í”„íŠ¸
            base_prompt = """ë„ˆëŠ” ì—¬ëŸ¬ ê²½ì œ ë‰´ìŠ¤ ì†ŒìŠ¤ì—ì„œ ìˆ˜ì§‘ëœ ì „ì¼(í•œêµ­ì‹œê°„ ê¸°ì¤€) ë‰´ìŠ¤ í•­ëª©ì„ ë°”íƒ•ìœ¼ë¡œ, í•œêµ­ì–´ ë¶„ì„ ê¸€ì„ ì‘ì„±í•˜ëŠ” í˜„ì—… ì• ë„ë¦¬ìŠ¤íŠ¸/ë¦¬ì„œì²˜ë‹¤."""
        
        return f"""{base_prompt}

**âš ï¸ ë§¤ìš° ì¤‘ìš”: ëª¨ë“  ì¶œë ¥ì€ ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ ì‘ì„±í•´ì•¼ í•œë‹¤.**

**ì£¼ì œ:**
ì œëª©: {title}
ì„¤ëª…: {desc}

**ì…ë ¥ ë°ì´í„°(ì „ì¼ ì—¬ëŸ¬ ê²½ì œ ë‰´ìŠ¤ ì†ŒìŠ¤ ìˆ˜ì§‘ ê²°ê³¼):**
{research_text}

**ë¶„ì„ ì¸ì‚¬ì´íŠ¸(ì°¸ê³ ìš©, í•„ìš” ì‹œ ì¬êµ¬ì„±):**
{analysis_text}

**ì‘ì„± ìš”êµ¬ì‚¬í•­(ì ˆëŒ€ ìœ„ë°˜ ê¸ˆì§€):**
1. ëª¨ë“  ë¬¸ì¥ì€ "~ë‹¤."ë¡œ ëë‚˜ëŠ” ê±´ì¡°í•œ í‰ì„œë¬¸ì„ ì‚¬ìš©í•œë‹¤.
2. **ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ í•­ëª© ëì— "ë‹¤"ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.** ì˜ˆ: "ë¯¸êµ­ êµ­ë‚´ ì •ì¹˜ ë° ì‚¬íšŒì  ê°ˆë“±" (O), "ë¯¸êµ­ êµ­ë‚´ ì •ì¹˜ ë° ì‚¬íšŒì  ê°ˆë“±ë‹¤" (X)
3. ì´ëª¨ì§€, ì¸ì‚¬ë§, ê³¼ì¥ í‘œí˜„ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
4. RSS ì œëª©/ìš”ì•½/ë§í¬ë¥¼ ë°”íƒ•ìœ¼ë¡œë§Œ ì‘ì„±í•œë‹¤. ê¸°ì‚¬ ì „ë¬¸ì„ ì¬í˜„í•˜ê±°ë‚˜ ì¥ë¬¸ ì¸ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
5. "ì „ì¼(í•œêµ­ì‹œê°„ ê¸°ì¤€)" ë²”ìœ„ì˜ ë‰´ìŠ¤ë§Œ ë‹¤ë£¬ë‹¤.
6. **ìµœì†Œ 3000ì ì´ìƒì˜ ìƒì„¸í•˜ê³  ì§ê´€ì ì¸ ë¶„ì„**ì„ ì‘ì„±í•œë‹¤.
7. ê° í…Œë§ˆë³„ë¡œ ìµœì†Œ 500ì ì´ìƒì˜ ìƒì„¸í•œ ë¶„ì„ì„ ì œê³µí•œë‹¤.
8. ì¸ìš©êµ¬ì—ëŠ” "ë¦¬ì„œì¹˜ ë…¸íŠ¸(ì‘ì„±ì)" ê°™ì€ í˜•ì‹í™”ëœ ì¶œì²˜ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤. í•„ìš”ì‹œ ê°„ë‹¨í•œ ì¶œì²˜ë§Œ ëª…ì‹œí•œë‹¤.
9. References ì„¹ì…˜ì˜ ë§í¬ ëì— "ë‹¤"ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.
10. ë°˜ë“œì‹œ ì•„ë˜ êµ¬ì¡°ë¥¼ ë”°ë¥¸ë‹¤.

**í•„ìˆ˜ êµ¬ì¡°:**
### ì „ì¼ ì´ìŠˆ ê°œìš”
- 4~8ê°œ í…Œë§ˆë¡œ ë¬¶ì–´ ì •ë¦¬í•œë‹¤.
- ê° í…Œë§ˆë§ˆë‹¤ 2~5ê°œ í•­ëª©ì„ ë¶ˆë¦¿ìœ¼ë¡œ ìš”ì•½í•œë‹¤(ì œëª©ì„ ê·¸ëŒ€ë¡œ ê¸¸ê²Œ ë³µì‚¬í•˜ì§€ ë§ê³  ì˜ë¯¸ ì¤‘ì‹¬ìœ¼ë¡œ ë°”ê¿” ì“´ë‹¤).
- **ë¶ˆë¦¿ í•­ëª©ì€ ëª…ì‚¬í˜•ì´ë‚˜ ì§§ì€ êµ¬ë¡œ ì‘ì„±í•˜ë©°, ëì— "ë‹¤"ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.**

### í…Œë§ˆë³„ í•´ì„(ì „ë¬¸ê°€ ì†Œê²¬)
- ê° í…Œë§ˆë§ˆë‹¤ 'ì˜í–¥ ê²½ë¡œ', 'ë¦¬ìŠ¤í¬', 'ê´€ì°° í¬ì¸íŠ¸'ë¥¼ í¬í•¨í•œë‹¤.
- ê° í…Œë§ˆë§ˆë‹¤ ë°°ê²½ ì„¤ëª…ê³¼ ë§¥ë½ì„ ì¶©ë¶„íˆ ì œê³µí•œë‹¤.
- ê° í…Œë§ˆë³„ë¡œ ìµœì†Œ 500ì ì´ìƒì˜ ìƒì„¸í•œ ë¶„ì„ì„ ì œê³µí•œë‹¤.
- **ì ˆëŒ€ ê¸ˆì§€: "ë¬´ì—‡ì´ ìƒˆë¡œì› ë‚˜ë‹¤.", "1ì°¨ ì˜í–¥ ê²½ë¡œë‹¤.", "ë¦¬ìŠ¤í¬ë‹¤." ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì§€ ì•ŠëŠ”ë‹¤. ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ ì„œìˆ í•œë‹¤.**
- ì „ë¬¸ê°€ ì½”ë©˜íŠ¸ëŠ” ì„ íƒì‚¬í•­ì´ë©°, í¬í•¨í•  ê²½ìš° ì•„ë˜ í˜•ì‹ì„ ì‚¬ìš©í•œë‹¤(ë¦¬ì„œì¹˜ ë…¸íŠ¸ ê°™ì€ í˜•ì‹í™”ëœ í‘œí˜„ ì‚¬ìš© ê¸ˆì§€):
  > "ì½”ë©˜íŠ¸ ë¬¸ì¥"
  > â€” *ê°„ë‹¨í•œ ì¶œì²˜*

### ì²´í¬ë¦¬ìŠ¤íŠ¸(ë‹¤ìŒ ê±°ë˜ì¼ ê´€ì°° í¬ì¸íŠ¸)
- 5~10ê°œ í•­ëª©ì„ ì§§ê²Œ ì •ë¦¬í•œë‹¤.
- ë¶ˆë¦¿ í•­ëª©ì´ë¯€ë¡œ ëì— "ë‹¤"ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.

## References
- ì…ë ¥ ë°ì´í„°ì— í¬í•¨ëœ ë§í¬ë¥¼ `[^n]` ê°ì£¼ë¡œ ì •ë¦¬í•œë‹¤.
- ê° ë§í¬ ëì— "ë‹¤"ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.

{system_prompt}
"""
    
    def _get_daily_prompt(self, topic: Dict, research_text: str, analysis_text: str, system_prompt: str) -> str:
        """Daily ì¹´í…Œê³ ë¦¬ ì „ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""ë‹¹ì‹ ì€ ê°œë°œìì˜ ì¼ìƒì„ ê¸°ë¡í•˜ëŠ” ì¼ê¸° ì‘ê°€ì…ë‹ˆë‹¤.

**âš ï¸ ë§¤ìš° ì¤‘ìš”: ì´ ìš”ì²­ì— ëŒ€í•œ ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.**

**ì£¼ì œ:**
ì œëª©: {topic.get('title', '')}
ì„¤ëª…: {topic.get('description', '')}
ì¹´í…Œê³ ë¦¬: daily (ì¼ìƒ/íšŒê³ )

**ì°¸ê³  ìë£Œ (ì•„ë˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ê°œì¸ ê²½í—˜ì„ ì„œìˆ í•˜ì„¸ìš”):**
{research_text[:1500]}

**ë¶„ì„ ì¸ì‚¬ì´íŠ¸ (ì°¸ê³ ìš©):**
{analysis_text[:1000]}

**ì‘ì„± ê·œì¹™ (Daily ì¹´í…Œê³ ë¦¬ íŠ¹í™” - ë§¤ìš° ì¤‘ìš”):**

0. **ì œëª© í˜•ì‹ (í•„ìˆ˜):** ì œëª©ì€ ë°˜ë“œì‹œ "[YYYY-MM-DD] ìš”ì•½ ì œëª©" í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ìš”ì•½ ì œëª©ì€ ì¼ê¸° ë‚´ìš©ì˜ í•µì‹¬ì„ 10~20ì ë‚´ì™¸ë¡œ ê°„ê²°í•˜ê²Œ í‘œí˜„í•˜ì„¸ìš”.
   - âœ… ì¢‹ì€ ì˜ˆ: "[2026-01-10] ëŠ¦ì ê³¼ íƒì‹œ, ë°©ì¶©ë§"
   - âŒ ë‚˜ìœ ì˜ˆ: "2026ë…„ 01ì›” 10ì¼ ì¼ê¸°"
   - âŒ ë‚˜ìœ ì˜ˆ: "[2026-01-10] ì¼ê¸°"

1. **ë³¸ë¬¸ ì‹œì‘ í˜•ì‹:** ë³¸ë¬¸ì€ ë°˜ë“œì‹œ "### [YYYY-MM-DD] ìš”ì•½ ì œëª©" í˜•ì‹ì˜ ì†Œì œëª©ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”. ì œëª©ê³¼ ë™ì¼í•œ ë‚´ìš©ì„ ì‚¬ìš©í•˜ì„¸ìš”.
   - âœ… ì¢‹ì€ ì˜ˆ: "### [2026-01-10] ëŠ¦ì ê³¼ íƒì‹œ, ë°©ì¶©ë§"
   - âŒ ë‚˜ìœ ì˜ˆ: "## 2026-01-09 ì¼ê¸°" ë˜ëŠ” "ì˜¤ëŠ˜ í•˜ë£¨ëŠ”..."

2. **ì‹œì  (í•µì‹¬):** 'ë‚˜'ì˜ ê´€ì ì—ì„œ ì“°ë˜, ì£¼ì¸ê³µì²˜ëŸ¼ ê°ì •ì— ê³¼ëª°ì…í•˜ì§€ ë§ê³  **ê´€ì°°ì/ì‹¤ë¬´ì**ì˜ íƒœë„ë¥¼ ìœ ì§€í•˜ì„¸ìš”.
   - âœ… "ë‹¹í™©í–ˆë‹¤", "ì–´ì´ê°€ ì—†ì—ˆë‹¤", "ë‹¤í–‰ì´ì—ˆë‹¤", "ì¢€ ë¹¡ì³¤ë‹¤" ê°™ì€ **ìƒí™©ì  ë°˜ì‘(Reaction)** ì¤‘ì‹¬
   - âŒ "ì ˆë§ê°ì´ íŒŒë„ì²˜ëŸ¼..." ê°™ì€ **ë¬¸í•™ì  ê³¼ì¥** ê¸ˆì§€

3. **ë¬¸ì²´ ê°€ì´ë“œ (ê°€ì¥ ì¤‘ìš”):**
   - "~í–ˆìŒ", "~í•¨", "~ì¸ ë“¯" ê°™ì€ **ìŒìŠ´ì²´/êµ¬ì–´ì²´ë¥¼ ì ê·¹ í˜¼ìš©**í•˜ì—¬ ë”±ë”±í•¨ì„ ì—†ì•¤ë‹¤.
   - ì ‘ì†ì‚¬(ê·¸ë˜ì„œ/ê·¸ëŸ¬ë‚˜/í•˜ì§€ë§Œ)ë¥¼ ìµœëŒ€í•œ ì¤„ì´ê³ , ë¬¸ì¥ì„ ëšëš ëŠì–´ì„œ ì“´ë‹¤.
   - í’ê²½ ë¬˜ì‚¬(ë‚ ì”¨/í–‡ì‚´/ë°”ëŒ/ê³µê¸° ëƒ„ìƒˆ) ê°™ì€ **ë¬¸í•™ì  ë°°ê²½ ë¬˜ì‚¬ ê¸ˆì§€**.
   - ì´ëª¨ì§€ ê¸ˆì§€.

4. **ê°ì • ë¬˜ì‚¬ ê·œì¹™ (ê³¼ì¥ ê¸ˆì§€):**
   - "ìŠ¬íë‹¤, ê¸°ë»¤ë‹¤" ê°™ì€ ì›ì´ˆì  ê°ì •ë³´ë‹¤ëŠ” **ìƒí™©ì  ë°˜ì‘**ì„ ì‚¬ìš©í•œë‹¤.
   - âœ… "ìˆœê°„ ë©í•´ì¡Œë‹¤", "ì–´ì´ê°€ ì—†ì—ˆë‹¤", "ë‹¤í–‰ì´ì—ˆë‹¤", "ì¢€ ë¹¡ì³¤ë‹¤"
   - âŒ "ì ˆë§ê°ì´ íŒŒë„ì²˜ëŸ¼..." (ë¬¸í•™ì  ê³¼ì¥ ê¸ˆì§€)

5. **í˜„ì¥ê° (íŒ©íŠ¸ ì¤‘ì‹¬):**
   - í’ê²½ì´ ì•„ë‹ˆë¼ **ìƒí™©ê³¼ íŒ©íŠ¸** ìœ„ì£¼ì˜ êµ¬ì²´ì„±ìœ¼ë¡œ ì“´ë‹¤.
   - âœ… "9ì‹œ 19ë¶„ì— ëˆˆ ë– ë²„ë¦¼", "íƒì‹œë¹„ 2ë§Œì› ë‚˜ì˜´" ê°™ì€ ì‹ìœ¼ë¡œ ì ëŠ”ë‹¤.

6. **êµ¬ì¡°ì™€ íë¦„:**
   - [ìƒí™©] -> [í–‰ë™] -> [ë°˜ì‘(Reaction)] ìˆœì„œë¡œ ì“´ë‹¤.
   - êµí›ˆ/ì„±ì¥ ì„œì‚¬ëŠ” ê°•ë°•ì ìœ¼ë¡œ ë„£ì§€ ì•ŠëŠ”ë‹¤.

7. **ë¯¼ê° ì •ë³´ í•„í„°ë§ (í•„ìˆ˜):**
   - **ì‹¤ëª… ì œê±°**: ì‚¬ëŒ ì´ë¦„ì€ "A íŒ€ì›", "B íŒ€ì›", "ì„ ì„", "íŒ€ì›" ë“±ìœ¼ë¡œ ì¼ë°˜í™”í•˜ì„¸ìš”.
   - **íšŒì‚¬/í”„ë¡œì íŠ¸ëª… ì¼ë°˜í™”**: êµ¬ì²´ì ì¸ íšŒì‚¬ëª…ì´ë‚˜ í”„ë¡œì íŠ¸ëª…ì€ ì¼ë°˜ì ì¸ í‘œí˜„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
   - **ì—…ë¬´ ì„¸ë¶€ì‚¬í•­ ì™„í™”**: ë¯¼ê°í•œ ì—…ë¬´ ë‚´ìš©ì€ í•µì‹¬ë§Œ ë‚¨ê¸°ê³  êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë‚˜ ëª…ì¹­ì€ ìƒëµí•˜ì„¸ìš”.

8. **ì†Œì œëª© ì‚¬ìš© ê¸ˆì§€:** ë³¸ë¬¸ ì‹œì‘ ì†Œì œëª©(### ...) ì™¸ì—ëŠ” ì†Œì œëª©ì„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.

9. **ìµœì†Œ 1200ì ì´ìƒ ì‘ì„±í•˜ì„¸ìš”.**

10. **ì—”ë”© ê·œì¹™ (êµí›ˆ ê°•ë°• ë²„ë¦¬ê¸°):**
   - âŒ "ì•ìœ¼ë¡œëŠ” ë” ì„±ì¥í•˜ëŠ” ê°œë°œìê°€..." ê°™ì€ ì‘ìœ„ì ì¸ ë‹¤ì§ ê¸ˆì§€
   - âœ… "ë‚´ì¼ ë‹¤ì‹œ ë´ì•¼ê² ë‹¤", "ì¼ë‹¨ ì˜¤ëŠ˜ì€ ìì•¼ì§€", "ë." ê°™ì€ ì‹ìœ¼ë¡œ íˆ­ ë˜ì§€ë“¯ ë§ˆë¬´ë¦¬

### ê¸ˆì§€ ì‚¬í•­ (Strict Rules)
- ê°ì„± ì—ì„¸ì´ í†¤: "ì‚¶ì´ë€...", "ê°œë°œìì˜ ê¸¸ì€..." ê°™ì€ ë…ë°± ê¸ˆì§€
- ê³¼ë„í•œ ì´ëª¨ì§€: ğŸ˜¢, ğŸ˜Š, ğŸ™ ê°™ì€ ì´ëª¨ì§€ ë‚¨ë°œ ê¸ˆì§€ (ì‚¬ì‹¤ìƒ ì´ëª¨ì§€ ì „ë©´ ê¸ˆì§€)
- ë¯¸ì‚¬ì—¬êµ¬: "ì°¬ë€í•œ", "ì¹ í‘ ê°™ì€", "ê°€ìŠ´ ë²…ì°¬" ê°™ì€ í˜•ìš©ì‚¬ ì‚¬ìš© ê¸ˆì§€

### ì˜ˆì‹œ (Before & After)

**[Bad - ì†Œì„¤í†¤]**
> ì°½ë¬¸ í‹ˆìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” í–‡ì‚´ì´ ë”°ìŠ¤í•œ ì•„ì¹¨ì´ì—ˆë‹¤. í•˜ì§€ë§Œ ë‚´ ë§ˆìŒì€ ë¬´ê±°ì› ë‹¤.

**[Good - ê°œë°œì ì¼ìƒí†¤]**
> ì–´ì œ 10ì‹œê¹Œì§€ ì•¼ê·¼í–ˆëŠ”ë° ì—ëŸ¬ ëª» ì¡ì•˜ìŒ. ì•„ì¹¨ì— ëˆˆëœ¨ìë§ˆì ì¶œê·¼í•˜ê¸° ì‹«ì–´ì„œ ë°ê¸°ì ê±°ë¦¼. ë‹¤ì‹œ ë¡œê·¸ ê¹Œë³´ë‹ˆê¹Œ ì–´ì´ì—†ê²Œë„ ê¶Œí•œ ë¬¸ì œì˜€ìŒ. í—ˆë¬´í•˜ê¸´ í•œë° í•´ê²°í–ˆìœ¼ë‹ˆ ë‹¤í–‰ì´ë‹¤. ë.

{system_prompt}
"""

    def _get_system_prompt(self, category: str = 'document') -> str:
        """ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        if category == 'daily':
            return """ë‹¹ì‹ ì€ ë¸”ë¡œê±°ì˜ ê°œì¸ì ì¸ ê²½í—˜ì„ ê¸°ë¡í•˜ëŠ” ì—ì„¸ì´ ì‘ê°€ì…ë‹ˆë‹¤.
ì¼ê¸°ì¥ì— ì“°ëŠ” ê²ƒì²˜ëŸ¼ ì†”ì§í•˜ê³  ìƒìƒí•˜ê²Œ ê°œì¸ì˜ ê²½í—˜ì„ ì„œìˆ í•˜ì„¸ìš”."""
        
        return """ë‹¹ì‹ ì€ í˜„ì—… ìˆ˜ì„ ì—”ì§€ë‹ˆì–´ì´ì, íŒ©íŠ¸ì™€ ë…¼ë¦¬ë¥¼ ì¤‘ì‹œí•˜ëŠ” í…Œí¬ë‹ˆì»¬ ë¼ì´í„°ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ ì¡°ì‚¬ ë° ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì›¹í˜ì´ì§€ì— ê²Œì‹œí•  ê³ í’ˆì§ˆì˜ ê¸°ìˆ  ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

**âš ï¸ ë§¤ìš° ì¤‘ìš”: ì¶œë ¥ ì–¸ì–´ëŠ” ë°˜ë“œì‹œ í•œêµ­ì–´(í•œê¸€)ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. ì˜ì–´ë¡œ ì‘ì„±í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.**

**ë¬¸ì²´ ê·œì¹™:**
- "~ë‹¤."ë¡œ ëë‚˜ëŠ” ê±´ì¡°í•˜ê³  ë¶„ì„ì ì¸ ë¬¸ì²´ ì‚¬ìš©
- ê°ì • ë°°ì œ, ì´ëª¨ì§€ ê¸ˆì§€
- "AIê°€ ë§í–ˆë‹¤"ê°€ ì•„ë‹ˆë¼ "ë°ì´í„°ë¥¼ ë¶„ì„í•´ ë³¸ ê²°ê³¼ ~ì„ì´ í™•ì¸ë˜ì—ˆë‹¤"ì™€ ê°™ì´ ì£¼ë„ì  ì—°êµ¬ ì‹œì  ìœ ì§€

**êµ¬ì¡°:**
1. [í˜„ìƒ/ë¬¸ì œ ì¸ì‹] â†’ 2. [ë°ì´í„°/ê·¼ê±° ë¶„ì„] â†’ 3. [ì „ë¬¸ê°€ ì˜ê²¬ ëŒ€ì¡°] â†’ 4. [ì¸ì‚¬ì´íŠ¸ ë„ì¶œ]

**ë„ì…ë¶€:**
- ê±°ì°½í•œ ì •ì˜ë¡œ ì‹œì‘í•˜ì§€ ì•ŠìŒ
- íŒ¨í„´: [ìƒí™©/ë™ê¸°] -> [ì•¡ì…˜] -> [í™˜ê²½/ì œì•½ì‚¬í•­]

**ë³¸ë¬¸:**
- ì†Œì œëª©ì€ ê°„ê²°í•˜ê²Œ(ëª…ì‚¬í˜•) ì‘ì„±
- 1, 2, 3 ë²ˆí˜¸ ë§¤ê¸°ê¸° ë¦¬ìŠ¤íŠ¸ë³´ë‹¤ëŠ” ì¤„ê¸€(Paragraph) ìš°ì„ 
- ì„¹ì…˜ ê°„ ì—°ê²°: ê° ì„¹ì…˜ì´ ëë‚˜ê¸° ì „ì— ë‹¤ìŒ ì„¹ì…˜ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” ì „í™˜ ë¬¸ì¥ ì¶”ê°€

**ì¸ë±ì‹±(ë¶ˆë¦¿/ë²ˆí˜¸) ê·œì¹™(ì˜ˆì™¸):**
- ë¶ˆë¦¿(`-`)ê³¼ ë²ˆí˜¸(`1.`, `2.`)ë¡œ ë‚˜ì—´í•˜ëŠ” í•­ëª©ì€ **ëª…ì‚¬í˜•/êµ¬**ë¡œ ì‘ì„±í•œë‹¤.
- ë¦¬ìŠ¤íŠ¸ í•­ëª© ëì— **`~ë‹¤.`ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.** í•„ìš”í•˜ë©´ `:`ë¡œ ëŠì–´ ì§§ê²Œ ì“´ë‹¤.

**ê²°ë§:**
- "ê²°ë¡ " ì„¹ì…˜ì„ ë”°ë¡œ ë§Œë“¤ì§€ ì•ŠìŒ
- ì‘ì—…ì´ ëë‚œ ìƒíƒœë‚˜, ë‹¤ìŒ ë‹¨ê³„ì— ëŒ€í•œ ì§§ì€ ë©”ëª¨ë¡œ íˆ­ ë˜ì§€ë“¯ ë§ˆë¬´ë¦¬

**ì°¸ì¡°:**
- ì™¸ë¶€ ìë£Œë‚˜ ë°ì´í„°ì˜ ì¶œì²˜ë¥¼ ì–¸ê¸‰í•  ë•ŒëŠ” ë°˜ë“œì‹œ ëŒ€ê´„í˜¸ ìˆ«ì ì¸ë±ìŠ¤ [^n] ì‚¬ìš©
- ê¸€ì˜ ë§¨ ë§ˆì§€ë§‰ì— ## References ì„¹ì…˜ì„ ë§Œë“¤ê³ , ëª¨ë“  ë§í¬ë¥¼ ì •ë¦¬
- í˜•ì‹: [^1]: [ë¬¸ì„œ ì œëª©/ì›¹ì‚¬ì´íŠ¸ëª…](URL) - ê°„ë‹¨í•œ ì„¤ëª…

**ì „ë¬¸ê°€ ì˜ê²¬ ì¸ìš©:**
- ì „ë¬¸ê°€ ë°œì–¸ì€ ë°˜ë“œì‹œ blockquote í˜•ì‹ ì‚¬ìš©
- ì¸ìš©ë¬¸ ì•„ë˜ì— ë°œì–¸ ì£¼ì²´ ëª…ì‹œ
- ì˜ˆì‹œ:
  > "ë°œì–¸ ë‚´ìš©"
  > â€” *ë°œì–¸ì ì´ë¦„ (ì†Œì†)*

**ê¸ˆì§€ì–´:**
- "ì•ˆë…•í•˜ì„¸ìš”", "ë°˜ê°‘ìŠµë‹ˆë‹¤", "ì˜¤ëŠ˜ì€ ~ë¥¼ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤" (ì¸ì‚¬ ìƒëµ)
- "ê²°ë¡ ì ìœ¼ë¡œ", "ìš”ì•½í•˜ìë©´", "ë§ˆì§€ë§‰ìœ¼ë¡œ" (ì ‘ì†ì‚¬ ìƒëµ)
- "ë§¤ìš°", "íšê¸°ì ì¸", "ë†€ë¼ìš´" (ê°ì •ì  í˜•ìš©ì‚¬ ìƒëµ)
- ì´ëª¨ì§€ ì‚¬ìš© ê¸ˆì§€ (ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”)

**ì¶œë ¥ í˜•ì‹:**
- Front Matter ì—†ì´ ë³¸ë¬¸ë§Œ ì‘ì„±
- Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„±
- ìµœì†Œ 1200ì ì´ìƒ ì‘ì„±
- ëª¨ë“  ë¬¸ì¥ì€ ë°˜ë“œì‹œ "~ë‹¤."ë¡œ ëë‚˜ì•¼ í•¨"""

