---
layout: default
title: 주식 대시보드
permalink: /stock/
---

<link rel="stylesheet" href="{{ '/assets/css/stock-feed.css' | relative_url }}">

<div class="stock-dashboard-container">
  <!-- 메인 차트 영역 -->
  <div class="stock-chart-main">
    <div class="chart-header">
      <div class="chart-title">
        <h2 id="chart-ticker">SOFI</h2>
        <span class="chart-subtitle" id="chart-name">SoFi Technologies, Inc.</span>
      </div>
      <div class="chart-controls">
        <select id="ticker-select" class="ticker-select">
          <option value="SOFI" selected>SOFI</option>
        </select>
        <button class="chart-refresh-btn" id="refresh-chart" title="새로고침">
          <i data-lucide="refresh-cw"></i>
        </button>
      </div>
    </div>
    <div class="chart-wrapper">
      <!-- TradingView Widget -->
      <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget" id="tradingview-widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
        {
          "autosize": true,
          "symbol": "NASDAQ:SOFI",
          "interval": "D",
          "timezone": "Asia/Seoul",
          "theme": "light",
          "style": "1",
          "locale": "kr",
          "backgroundColor": "transparent",
          "gridColor": "rgba(0, 0, 0, 0.06)",
          "hide_side_toolbar": false,
          "allow_symbol_change": true,
          "calendar": false,
          "support_host": "https://www.tradingview.com"
        }
        </script>
      </div>
    </div>
  </div>

  <!-- 우측 사이드바 -->
  <aside class="stock-sidebar">
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" data-tab="digest">
        <i data-lucide="newspaper" class="tab-icon"></i>
        <span class="tab-label">경제 뉴스 다이제스트</span>
      </button>
      <button class="sidebar-tab" data-tab="realtime">
        <i data-lucide="rss" class="tab-icon"></i>
        <span class="tab-label">실시간 소식</span>
      </button>
      <button class="sidebar-tab" data-tab="watchlist">
        <i data-lucide="star" class="tab-icon"></i>
        <span class="tab-label">관심종목 (SOFI)</span>
      </button>
    </div>

    <div class="sidebar-content">
      <!-- 탭 1: 경제 뉴스 다이제스트 -->
      <div class="tab-panel active" id="panel-digest">
        <div class="panel-header">
          <h3>전날 이슈 요약</h3>
          <span class="panel-subtitle">경제 뉴스 다이제스트</span>
        </div>
        <div class="digest-list" id="digest-list">
          {% assign digest_posts = site.posts | where_exp: "post", "post.title contains '다이제스트' or post.title contains '블룸버그' or post.title contains '경제'" | limit: 5 %}
          {% if digest_posts.size > 0 %}
            {% for post in digest_posts %}
              <a href="{{ post.url | relative_url }}" class="digest-item">
                <div class="digest-item-header">
                  <span class="digest-item-number">{{ forloop.index }}</span>
                  <span class="digest-item-date">{{ post.date | date: "%Y.%m.%d" }}</span>
                </div>
                <div class="digest-item-title">{{ post.title | escape }}</div>
              </a>
            {% endfor %}
          {% else %}
            <div class="empty-message">다이제스트가 없습니다.</div>
          {% endif %}
        </div>
      </div>

      <!-- 탭 2: 실시간 소식 -->
      <div class="tab-panel" id="panel-realtime">
        <div class="panel-header">
          <h3>실시간 뉴스</h3>
          <span class="panel-subtitle" id="realtime-updated">마지막 업데이트: 로딩 중...</span>
        </div>
        <div class="realtime-list" id="realtime-list">
          <div class="loading-message">로딩 중...</div>
        </div>
      </div>

      <!-- 탭 3: 관심종목 (SOFI) -->
      <div class="tab-panel" id="panel-watchlist">
        <div class="panel-header">
          <h3>SOFI 소식</h3>
          <span class="panel-subtitle">SoFi Technologies, Inc.</span>
        </div>
        <div class="watchlist-list" id="watchlist-list">
          <div class="loading-message">로딩 중...</div>
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
  // Lucide Icons 초기화 (이미 default.html에서 로드됨)
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }

  let allFeedItems = [];
  let currentTab = 'digest';

  // 탭 전환
  document.querySelectorAll('.sidebar-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabId = tab.dataset.tab;
      
      // 탭 활성화
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // 패널 전환
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`panel-${tabId}`).classList.add('active');
      
      currentTab = tabId;
      
      // 탭별 데이터 로드
      if (tabId === 'realtime') {
        loadRealtimeFeed();
      } else if (tabId === 'watchlist') {
        loadWatchlistFeed();
      }
    });
  });

  // 상대 시간 포맷팅
  function formatRelativeTime(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diffSeconds = Math.floor((now - time) / 1000);

    if (diffSeconds < 60) {
      return '방금 전';
    } else if (diffSeconds < 3600) {
      const minutes = Math.floor(diffSeconds / 60);
      return `${minutes}분 전`;
    } else if (diffSeconds < 86400) {
      const hours = Math.floor(diffSeconds / 3600);
      return `${hours}시간 전`;
    } else {
      const days = Math.floor(diffSeconds / 86400);
      return `${days}일 전`;
    }
  }

  // 다이제스트는 Liquid 템플릿으로 렌더링되므로 별도 로드 불필요

  // 실시간 피드 로드
  async function loadRealtimeFeed() {
    try {
      const timestamp = new Date().getTime();
      const response = await fetch(`/assets/data/stock_feed.json?t=${timestamp}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      allFeedItems = data.items || [];

      if (data.last_updated) {
        const lastUpdated = new Date(data.last_updated);
        document.getElementById('realtime-updated').textContent = 
          `마지막 업데이트: ${lastUpdated.toLocaleString('ko-KR')}`;
      }

      renderRealtimeFeed(allFeedItems.slice(0, 10));
    } catch (error) {
      console.error('실시간 피드 로드 실패:', error);
      document.getElementById('realtime-list').innerHTML = 
        '<div class="error-message">피드를 불러올 수 없습니다.</div>';
    }
  }

  // 실시간 피드 렌더링
  function renderRealtimeFeed(items) {
    const container = document.getElementById('realtime-list');
    
    if (items.length === 0) {
      container.innerHTML = '<div class="empty-message">표시할 항목이 없습니다.</div>';
      return;
    }

    container.innerHTML = items.map(item => {
      const sentimentBadge = item.sentiment === 'POSITIVE' 
        ? '<span class="sentiment-badge positive">호재</span>'
        : item.sentiment === 'NEGATIVE'
        ? '<span class="sentiment-badge negative">악재</span>'
        : '';
      
      return `
        <div class="realtime-item">
          <div class="realtime-item-header">
            <span class="realtime-source">${item.source_name}</span>
            ${sentimentBadge}
            <span class="realtime-time">${formatRelativeTime(item.timestamp)}</span>
          </div>
          <div class="realtime-content">${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}</div>
          <a href="${item.url}" target="_blank" rel="noopener" class="realtime-link">원문 보기 →</a>
        </div>
      `;
    }).join('');
  }

  // 관심종목 (SOFI) 피드 로드
  async function loadWatchlistFeed() {
    try {
      const timestamp = new Date().getTime();
      const response = await fetch(`/assets/data/stock_feed.json?t=${timestamp}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      const sofiItems = (data.items || []).filter(item => 
        item.related_tickers && item.related_tickers.includes('SOFI')
      ).slice(0, 10);

      renderWatchlistFeed(sofiItems);
    } catch (error) {
      console.error('관심종목 피드 로드 실패:', error);
      document.getElementById('watchlist-list').innerHTML = 
        '<div class="error-message">피드를 불러올 수 없습니다.</div>';
    }
  }

  // 관심종목 피드 렌더링
  function renderWatchlistFeed(items) {
    const container = document.getElementById('watchlist-list');
    
    if (items.length === 0) {
      container.innerHTML = '<div class="empty-message">SOFI 관련 소식이 없습니다.</div>';
      return;
    }

    container.innerHTML = items.map(item => {
      const sentimentBadge = item.sentiment === 'POSITIVE' 
        ? '<span class="sentiment-badge positive">호재</span>'
        : item.sentiment === 'NEGATIVE'
        ? '<span class="sentiment-badge negative">악재</span>'
        : '';
      
      return `
        <div class="watchlist-item">
          <div class="watchlist-item-header">
            <span class="watchlist-source">${item.source_name}</span>
            ${sentimentBadge}
            <span class="watchlist-time">${formatRelativeTime(item.timestamp)}</span>
          </div>
          <div class="watchlist-content">${item.content}</div>
          <a href="${item.url}" target="_blank" rel="noopener" class="watchlist-link">원문 보기 →</a>
        </div>
      `;
    }).join('');
  }

  // 차트 새로고침
  document.getElementById('refresh-chart')?.addEventListener('click', () => {
    const widget = document.getElementById('tradingview-widget');
    if (widget) {
      widget.innerHTML = '';
      // TradingView 위젯 재로드
      const script = document.createElement('script');
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
      script.async = true;
      script.textContent = JSON.stringify({
        "autosize": true,
        "symbol": "NASDAQ:SOFI",
        "interval": "D",
        "timezone": "Asia/Seoul",
        "theme": "light",
        "style": "1",
        "locale": "kr",
        "backgroundColor": "transparent",
        "gridColor": "rgba(0, 0, 0, 0.06)",
        "hide_side_toolbar": false,
        "allow_symbol_change": true,
        "calendar": false,
        "support_host": "https://www.tradingview.com"
      });
      widget.appendChild(script);
    }
  });

  // 초기 로드
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      if (currentTab === 'realtime') {
        loadRealtimeFeed();
      } else if (currentTab === 'watchlist') {
        loadWatchlistFeed();
      }
    });
  } else {
    if (currentTab === 'realtime') {
      loadRealtimeFeed();
    } else if (currentTab === 'watchlist') {
      loadWatchlistFeed();
    }
  }

  // 5분마다 실시간 피드 업데이트
  setInterval(() => {
    if (currentTab === 'realtime') {
      loadRealtimeFeed();
    } else if (currentTab === 'watchlist') {
      loadWatchlistFeed();
    }
  }, 300000);
</script>
