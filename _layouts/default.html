<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
    <meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
    
    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
    <link rel="canonical" href="{{ page.url | replace:'index.html','' | absolute_url }}">
    
    <!-- Google Analytics 4 (GA4) -->
    {% if site.google_analytics %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ site.google_analytics }}');
    </script>
    {% endif %}
    
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" id="prism-theme-light">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" id="prism-theme-dark" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    
    <!-- MathJax for LaTeX -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        }
      };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    {% comment %}{% seo %}{% endcomment %}
  </head>
  <body class="{% if page.url == '/' or page.url == '/index.html' %}home-page{% endif %}">
    <header class="site-header">
      <div class="wrapper">
        <a class="site-title" href="{{ '/' | relative_url }}">{{ site.title }}</a>
        <nav class="site-nav">
          <div class="trigger">
            {% for item in site.navigation %}
              <a class="page-link" href="{{ item.url | relative_url }}">{{ item.title }}</a>
            {% endfor %}
            <!-- 라이트/다크 모드 토글 (Uiverse RiccardoRapelli jolly-chicken-91) -->
            <label class="switch theme-toggle" aria-label="테마 전환">
              <input id="themeToggleInput" type="checkbox" />
              <div class="slider round">
                <div class="sun-moon">
                  <svg id="moon-dot-1" class="moon-dot" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="moon-dot-2" class="moon-dot" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="moon-dot-3" class="moon-dot" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="light-ray-1" class="light-ray" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="light-ray-2" class="light-ray" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="light-ray-3" class="light-ray" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="cloud-1" class="cloud-dark" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="cloud-2" class="cloud-dark" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="cloud-3" class="cloud-dark" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="cloud-4" class="cloud-light" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="cloud-5" class="cloud-light" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                  <svg id="cloud-6" class="cloud-light" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="50"></circle>
                  </svg>
                </div>
                <div class="stars">
                  <svg id="star-1" class="star" viewBox="0 0 20 20">
                    <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                  </svg>
                  <svg id="star-2" class="star" viewBox="0 0 20 20">
                    <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                  </svg>
                  <svg id="star-3" class="star" viewBox="0 0 20 20">
                    <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                  </svg>
                  <svg id="star-4" class="star" viewBox="0 0 20 20">
                    <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                  </svg>
                </div>
              </div>
            </label>
          </div>
        </nav>
      </div>
    </header>

    <main class="page-content">
      <div class="wrapper">
        {{ content }}
      </div>
    </main>

    {% unless page.url == '/' or page.url == '/index.html' %}
    <footer class="site-footer">
      <div class="wrapper">
        <p>&copy; {{ 'now' | date: "%Y" }} {{ site.author }}. All rights reserved.</p>
        <p>Powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">GitHub Pages</a></p>
      </div>
    </footer>
    {% endunless %}
    
    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    
    <script>
      // 메인 페이지인지 확인하여 body에 클래스 추가
      if (window.location.pathname === '/' || window.location.pathname === '/index.html') {
        document.documentElement.classList.add('home-page');
      }

      // 카테고리 토글 함수
      function toggleCategory(link) {
        const categoryItem = link.closest('.category-item');
        const isActive = categoryItem.classList.contains('active');
        
        // 다른 카테고리 닫기 (선택사항 - 원하면 주석 처리)
        // document.querySelectorAll('.category-item').forEach(item => {
        //   if (item !== categoryItem) {
        //     item.classList.remove('active');
        //   }
        // });
        
        // 현재 카테고리 토글
        if (isActive) {
          categoryItem.classList.remove('active');
        } else {
          categoryItem.classList.add('active');
        }
      }

      // 코드 블록 확장 기능 및 팝업 모달
      function processCodeBlocks() {
        const codeBlocks = document.querySelectorAll('.post-content pre');
        
        codeBlocks.forEach(pre => {
          pre.classList.add('line-numbers');
          pre.removeAttribute('tabindex');
          pre.style.outline = 'none';
          
          const code = pre.querySelector('code');
          if (!code) return;

          // 언어 추출 및 data-lang 표시
          const langMatch = code.className.match(/language-([\w-]+)/);
          const lang = langMatch ? langMatch[1] : 'code';
          pre.setAttribute('data-lang', lang);

          // 라인넘버 플러그인용 클래스는 pre에만 유지
          code.classList.remove('line-numbers');

          // 긴 코드일 때만 확장 가능 표시
          const lines = (code.textContent || code.innerText || '').split('\n');
          if (lines.length > 15) {
            pre.classList.add('code-expandable');
          } else {
            pre.classList.remove('code-expandable');
          }

          // 상단 우측 + 버튼 생성 (중복 방지)
          if (!pre.querySelector('.code-expand-btn')) {
            const btn = document.createElement('button');
            btn.className = 'code-expand-btn';
            btn.innerHTML = '+';
            btn.setAttribute('aria-label', '전체 코드 보기');
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              openCodeModal(pre, lang);
            });
            pre.appendChild(btn);
          }
        });
      }
      
      // 코드 팝업 모달 열기
      function openCodeModal(preElement, langOverride) {
        // 모달이 이미 있으면 제거
        const existingModal = document.getElementById('code-modal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // 모달 생성
        const modal = document.createElement('div');
        modal.id = 'code-modal';
        modal.className = 'code-modal';
        
        const code = preElement.querySelector('code');
        const codeClone = code.cloneNode(true);
        
        // 언어 클래스 가져오기
        const language = code.className.match(/language-([\w-]+)/);
        const langClass = langOverride ? `language-${langOverride}` : (language ? language[0] : '');
        
        modal.innerHTML = `
          <div class="code-modal-content">
            <div class="code-modal-header">
              <h3 class="code-modal-title">전체 코드${langClass ? ' (' + langClass.replace('language-', '') + ')' : ''}</h3>
              <button class="code-modal-close">닫기</button>
            </div>
            <div class="code-modal-body">
              <pre class="highlight ${langClass}"><code class="${langClass}">${codeClone.innerHTML}</code></pre>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Prism.js로 하이라이팅 (있는 경우)
        if (window.Prism && window.Prism.highlightElement) {
          const modalCode = modal.querySelector('code');
          if (modalCode) {
            window.Prism.highlightElement(modalCode);
          }
        }
        
        // 애니메이션을 위해 약간의 지연 후 active 클래스 추가
        setTimeout(() => {
          modal.classList.add('active');
        }, 10);
        
        // 닫기 버튼 이벤트
        const closeBtn = modal.querySelector('.code-modal-close');
        closeBtn.addEventListener('click', () => {
          closeCodeModal(modal);
        });
        
        // 배경 클릭 시 닫기
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeCodeModal(modal);
          }
        });
        
        // ESC 키로 닫기
        const escHandler = function(e) {
          if (e.key === 'Escape') {
            closeCodeModal(modal);
            document.removeEventListener('keydown', escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);
      }
      
      
      // 코드 팝업 모달 닫기
      function closeCodeModal(modal) {
        modal.classList.remove('active');
        setTimeout(() => {
          modal.remove();
        }, 300);
      }
      
      // DOMContentLoaded와 Prism.js 로드 후 실행
      document.addEventListener('DOMContentLoaded', function() {
        processCodeBlocks();
        
        // Prism.js가 로드된 후에도 실행
        if (window.Prism) {
          setTimeout(processCodeBlocks, 100);
        }
      });
      
      // Prism.js autoloader가 완료된 후 실행
      if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
        window.Prism.plugins.autoloader.onload = function() {
          setTimeout(processCodeBlocks, 100);
        };
      }
      
      // 테마 전환 기능
      (function() {
        const themeInput = document.getElementById('themeToggleInput');
        const html = document.documentElement;
        const prismLight = document.getElementById('prism-theme-light');
        const prismDark = document.getElementById('prism-theme-dark');
        
        // 저장된 테마 불러오기
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        if (themeInput) {
          themeInput.checked = savedTheme === 'dark';
        }
        updatePrismTheme(savedTheme);
        
        // Prism 테마 업데이트 함수
        function updatePrismTheme(theme) {
          if (prismLight && prismDark) {
            if (theme === 'dark') {
              prismLight.disabled = true;
              prismDark.disabled = false;
            } else {
              prismLight.disabled = false;
              prismDark.disabled = true;
            }
          }
        }
        
        // 토글 change 이벤트
        if (themeInput) {
          themeInput.addEventListener('change', function() {
            const newTheme = themeInput.checked ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updatePrismTheme(newTheme);
            
            // Prism.js 재하이라이팅
            if (window.Prism) {
              document.querySelectorAll('pre code').forEach(function(block) {
                Prism.highlightElement(block);
              });
            }
          });
        }
      })();
    </script>
  </body>
</html>
